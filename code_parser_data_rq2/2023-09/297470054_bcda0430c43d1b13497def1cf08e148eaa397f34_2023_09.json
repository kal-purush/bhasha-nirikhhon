{
    "identifiers": [
        "google",
        "cloud",
        "bigquery",
        "datetime",
        "date",
        "timedelta",
        "datetime",
        "collections",
        "namedtuple",
        "numpy",
        "np",
        "pandas",
        "pd",
        "asyncio",
        "re",
        "json",
        "metadata_source",
        "languages_source",
        "re",
        "fullmatch",
        "metadata_source",
        "metadata_source",
        "re",
        "fullmatch",
        "languages_source",
        "languages_source",
        "metadata_source_no_injection",
        "languages_source_no_injection",
        "bigquery",
        "Client",
        "client",
        "query",
        "SUCCESSFUL_SANITIZATION_JOB_RUN_METADATA",
        "query_job",
        "result",
        "to_dataframe",
        "results_as_dataframe",
        "dataframe",
        "destination_table_id",
        "bigquery",
        "Client",
        "bigquery",
        "SchemaField",
        "bigquery",
        "enums",
        "SqlTypeNames",
        "STRING",
        "bigquery",
        "SchemaField",
        "bigquery",
        "enums",
        "SqlTypeNames",
        "FLOAT64",
        "bigquery",
        "SchemaField",
        "bigquery",
        "enums",
        "SqlTypeNames",
        "FLOAT64",
        "bigquery",
        "SchemaField",
        "bigquery",
        "enums",
        "SqlTypeNames",
        "FLOAT64",
        "bigquery",
        "SchemaField",
        "bigquery",
        "enums",
        "SqlTypeNames",
        "FLOAT64",
        "bigquery",
        "SchemaField",
        "bigquery",
        "enums",
        "SqlTypeNames",
        "FLOAT64",
        "bigquery",
        "SchemaField",
        "bigquery",
        "enums",
        "SqlTypeNames",
        "FLOAT64",
        "bigquery",
        "SchemaField",
        "bigquery",
        "enums",
        "SqlTypeNames",
        "FLOAT64",
        "bigquery",
        "SchemaField",
        "bigquery",
        "enums",
        "SqlTypeNames",
        "FLOAT64",
        "bigquery",
        "Table",
        "destination_table_id",
        "client",
        "insert_rows_from_dataframe",
        "table",
        "destination_table",
        "dataframe",
        "dataframe",
        "selected_fields",
        "schema",
        "job",
        "metrics_source",
        "re",
        "fullmatch",
        "metrics_source",
        "metrics_source",
        "metrics_source_no_injection",
        "bigquery",
        "Client",
        "client",
        "query",
        "DATA_VALIDATION_METRICS_QUERY",
        "query_job",
        "result",
        "to_dataframe",
        "results_as_dataframe",
        "validation_data",
        "pd",
        "DataFrame",
        "metric",
        "full_lookback_window",
        "test_window",
        "range_lower_bound",
        "range_upper_bound",
        "metric",
        "range_lower_bound",
        "range_upper_bound",
        "validation_data",
        "columns",
        "values",
        "metric",
        "validation_data",
        "columns",
        "values",
        "metric",
        "date",
        "today",
        "max",
        "validation_data",
        "today",
        "timedelta",
        "days",
        "test_window",
        "test_earliest_date",
        "timedelta",
        "days",
        "full_lookback_window",
        "validation_data",
        "apply",
        "m",
        "comparison_earliest_date",
        "m",
        "date",
        "test_earliest_date",
        "validation_data",
        "apply",
        "m",
        "test_earliest_date",
        "m",
        "date",
        "today",
        "validation_data",
        "loc",
        "comparison_values",
        "validation_data",
        "loc",
        "test_values",
        "comparison_range",
        "metric",
        "quantile",
        "q",
        "range_lower_bound",
        "range_upper_bound",
        "len",
        "test_range",
        "metric",
        "all",
        "test_range",
        "metric",
        "range_upper",
        "all",
        "test_range",
        "metric",
        "range_lower",
        "metric",
        "latest_finished_at",
        "len",
        "comparison_range",
        "should_trigger",
        "range_lower",
        "range_upper",
        "test_range",
        "metric",
        "validation_data",
        "pd",
        "DataFrame",
        "metric",
        "full_lookback_window",
        "test_window",
        "moving_average_window",
        "mean_lower_bound",
        "mean_upper_bound",
        "metric",
        "mean_lower_bound",
        "mean_upper_bound",
        "validation_data",
        "columns",
        "values",
        "metric",
        "validation_data",
        "columns",
        "values",
        "metric",
        "date",
        "today",
        "max",
        "validation_data",
        "today",
        "timedelta",
        "days",
        "test_window",
        "test_earliest_date",
        "timedelta",
        "days",
        "full_lookback_window",
        "moving_average_window",
        "metric",
        "validation_data",
        "metric",
        "rolling",
        "moving_average_window",
        "min_periods",
        "mean",
        "validation_data",
        "apply",
        "m",
        "comparison_earliest_date",
        "m",
        "date",
        "test_earliest_date",
        "validation_data",
        "apply",
        "m",
        "test_earliest_date",
        "m",
        "date",
        "today",
        "validation_data",
        "loc",
        "comparison_values",
        "validation_data",
        "loc",
        "test_values",
        "comparison_range",
        "x_day_moving_average",
        "quantile",
        "q",
        "mean_lower_bound",
        "mean_upper_bound",
        "test_range",
        "x_day_moving_average",
        "len",
        "test_moving_averages",
        "all",
        "test_moving_averages",
        "mean_upper",
        "all",
        "test_moving_averages",
        "mean_lower",
        "comparison_range",
        "x_day_moving_average",
        "notna",
        "sum",
        "metric",
        "latest_finished_at",
        "num_moving_averages_compared",
        "should_trigger",
        "mean_lower",
        "mean_upper",
        "moving_average_window",
        "test_moving_averages",
        "val_df",
        "destination_table",
        "destination_table",
        "namedtuple",
        "bigquery",
        "Client",
        "datetime",
        "utcnow",
        "metric",
        "InputSet",
        "name",
        "full_lookback_window",
        "range_test_window",
        "range_lower_bound",
        "range_upper_bound",
        "mean_test_window",
        "mean_lower_bound",
        "mean_upper_bound",
        "moving_average_window",
        "InputSet",
        "name",
        "full_lookback_window",
        "range_test_window",
        "range_lower_bound",
        "range_upper_bound",
        "mean_test_window",
        "mean_lower_bound",
        "mean_upper_bound",
        "moving_average_window",
        "InputSet",
        "name",
        "full_lookback_window",
        "range_test_window",
        "range_lower_bound",
        "range_upper_bound",
        "mean_test_window",
        "mean_lower_bound",
        "mean_upper_bound",
        "moving_average_window",
        "InputSet",
        "name",
        "full_lookback_window",
        "range_test_window",
        "range_lower_bound",
        "range_upper_bound",
        "mean_test_window",
        "mean_lower_bound",
        "mean_upper_bound",
        "moving_average_window",
        "InputSet",
        "name",
        "full_lookback_window",
        "range_test_window",
        "range_lower_bound",
        "range_upper_bound",
        "mean_test_window",
        "mean_lower_bound",
        "mean_upper_bound",
        "moving_average_window",
        "InputSet",
        "name",
        "full_lookback_window",
        "range_test_window",
        "range_lower_bound",
        "range_upper_bound",
        "mean_test_window",
        "mean_lower_bound",
        "mean_upper_bound",
        "moving_average_window",
        "InputSet",
        "name",
        "full_lookback_window",
        "range_test_window",
        "range_lower_bound",
        "range_upper_bound",
        "mean_test_window",
        "mean_lower_bound",
        "mean_upper_bound",
        "moving_average_window",
        "InputSet",
        "name",
        "full_lookback_window",
        "range_test_window",
        "range_lower_bound",
        "range_upper_bound",
        "mean_test_window",
        "mean_lower_bound",
        "mean_upper_bound",
        "moving_average_window",
        "range_check",
        "val_df",
        "metric",
        "name",
        "metric",
        "full_lookback_window",
        "metric",
        "range_test_window",
        "metric",
        "range_lower_bound",
        "metric",
        "range_upper_bound",
        "mean_check",
        "val_df",
        "metric",
        "name",
        "metric",
        "full_lookback_window",
        "metric",
        "mean_test_window",
        "metric",
        "moving_average_window",
        "metric",
        "mean_lower_bound",
        "metric",
        "mean_upper_bound",
        "finished_at",
        "strftime",
        "started_at",
        "strftime",
        "range_alarm",
        "range_low",
        "range_high",
        "num_ranges_compared",
        "range_test_vals",
        "mean_alarm",
        "mean_low",
        "mean_high",
        "num_moving_averages_compared",
        "mean_test_vals",
        "metric",
        "name",
        "metric",
        "full_lookback_window",
        "metric",
        "range_test_window",
        "metric",
        "mean_test_window",
        "metric",
        "moving_average_window",
        "metric",
        "range_lower_bound",
        "metric",
        "range_upper_bound",
        "metric",
        "range_lower_bound",
        "metric",
        "range_upper_bound",
        "client",
        "insert_rows_json",
        "destination_table",
        "rows_to_insert",
        "errors",
        "errors"
    ],
    "literals": [
        "r\"[A-Za-z0-9\\.\\-\\_]+\"",
        "\"metadata_source in incorrect format. This should be a fully qualified table name like myproject.mydataset.my_table\"",
        "r\"[A-Za-z0-9\\.\\-\\_]+\"",
        "\"metadata_source in incorrect format. This should be a fully qualified table name like myproject.mydataset.my_table\"",
        "f\"\"\"\n    SELECT\n        finished_at,\n        SAFE_DIVIDE(total_search_terms_removed_by_sanitization_job, total_search_terms_analyzed) AS pct_sanitized_search_terms,\n        SAFE_DIVIDE(contained_at, total_search_terms_analyzed) AS pct_sanitized_contained_at,\n        SAFE_DIVIDE(contained_numbers, total_search_terms_analyzed) AS pct_sanitized_contained_numbers,\n        SAFE_DIVIDE(contained_name, total_search_terms_analyzed) AS pct_sanitized_contained_name,\n        SAFE_DIVIDE(sum_terms_containing_us_census_surname, total_search_terms_analyzed) AS pct_terms_containing_us_census_surname,\n        SAFE_DIVIDE(sum_uppercase_chars_all_search_terms, sum_chars_all_search_terms) AS pct_uppercase_chars_all_search_terms,\n        SAFE_DIVIDE(sum_words_all_search_terms, total_search_terms_analyzed) AS avg_words_all_search_terms,\n        1 - SAFE_DIVIDE(languages.english_count, languages.all_languages_count) AS pct_terms_non_english\n        FROM `{metadata_source_no_injection}` AS metadata\n    JOIN \n    (\n        SELECT \n            job_start_time,\n            max(case when language_code = 'en' then search_term_count end) english_count,\n            sum(search_term_count) as all_languages_count,\n        FROM `{languages_source_no_injection}` \n        GROUP BY job_start_time\n    ) AS languages\n    ON metadata.started_at = languages.job_start_time\n    WHERE status = 'SUCCESS'\n    ORDER BY finished_at ASC;\n    \"\"\"",
        "\"finished_at\"",
        "\"pct_sanitized_search_terms\"",
        "\"pct_sanitized_contained_at\"",
        "\"pct_sanitized_contained_numbers\"",
        "\"pct_sanitized_contained_name\"",
        "\"pct_terms_containing_us_census_surname\"",
        "\"pct_uppercase_chars_all_search_terms\"",
        "\"avg_words_all_search_terms\"",
        "\"pct_terms_non_english\"",
        "r\"[A-Za-z0-9\\.\\-\\_]+\"",
        "\"metadata_source in incorrect format. This should be a fully qualified table name like myproject.mydataset.my_table\"",
        "f\"\"\"\n    SELECT\n        *\n        FROM `{metrics_source_no_injection}` AS metadata\n    ORDER BY finished_at ASC;\n    \"\"\"",
        "f\"Performing range check for metric: {metric}\"",
        "\"range_lower_bound and range_upper_bound should both be between zero (0) and one (1).\"",
        "\"finished_at\"",
        "\"dataframe must include a finished_at column.\"",
        "f'dataframe does not include target metric \"{metric}\"'",
        "\"finished_at\"",
        "\"finished_at\"",
        "\"finished_at\"",
        "f\"Completed range check for metric: {metric}\"",
        "f\"Performing mean check for metric: {metric}\"",
        "\"mean_lower_bound and mean_upper_bound should both be between zero (0) and one (1).\"",
        "\"finished_at\"",
        "\"dataframe must include a finished_at column.\"",
        "f'dataframe does not include target metric \"{metric}\"'",
        "\"finished_at\"",
        "f\"{moving_average_window}_day_{metric}_moving_avg\"",
        "\"finished_at\"",
        "\"finished_at\"",
        "f\"Completed mean check for metric: {metric}\"",
        "f\"Recording validation results to destination table: {destination_table}\"",
        "\"InputSet\"",
        "\"name full_lookback_window range_test_window range_lower_bound range_upper_bound mean_test_window mean_lower_bound mean_upper_bound moving_average_window\"",
        "\"pct_sanitized_search_terms\"",
        "\"pct_sanitized_contained_at\"",
        "\"pct_sanitized_contained_numbers\"",
        "\"pct_sanitized_contained_name\"",
        "\"pct_terms_containing_us_census_surname\"",
        "\"pct_uppercase_chars_all_search_terms\"",
        "\"avg_words_all_search_terms\"",
        "\"pct_terms_non_english\"",
        "\"from_sanitization_job_finished_at\"",
        "\"%Y-%m-%d %H:%M:%S\"",
        "\"started_at\"",
        "\"%Y-%m-%d %H:%M:%S\"",
        "\"range_alarm\"",
        "\"range_low\"",
        "\"range_high\"",
        "\"num_ranges_compared\"",
        "\"range_test_vals\"",
        "\"mean_alarm\"",
        "\"mean_low\"",
        "\"mean_high\"",
        "\"num_moving_averages_compared\"",
        "\"mean_test_vals\"",
        "\"metric\"",
        "\"full_lookback_window_num_days\"",
        "\"range_test_window_num_days\"",
        "\"mean_test_window_num_days\"",
        "\"moving_average_window_num_days\"",
        "\"range_percentile_lower_bound\"",
        "\"range_percentile_upper_bound\"",
        "\"mean_percentile_lower_bound\"",
        "\"mean_percentile_upper_bound\"",
        "f\"Problem recording data validation results: {errors}\"",
        "\"Data validation results recorded successfully!\""
    ],
    "variables": [
        "metadata_source_no_injection",
        "languages_source_no_injection",
        "SUCCESSFUL_SANITIZATION_JOB_RUN_METADATA",
        "client",
        "query_job",
        "results_as_dataframe",
        "client",
        "schema",
        "destination_table",
        "job",
        "metrics_source_no_injection",
        "DATA_VALIDATION_METRICS_QUERY",
        "client",
        "query_job",
        "results_as_dataframe",
        "today",
        "latest_finished_at",
        "test_earliest_date",
        "comparison_earliest_date",
        "comparison_values",
        "test_values",
        "comparison_range",
        "test_range",
        "range_lower",
        "range_upper",
        "should_trigger",
        "today",
        "latest_finished_at",
        "test_earliest_date",
        "comparison_earliest_date",
        "x_day_moving_average",
        "validation_data",
        "x_day_moving_average",
        "comparison_values",
        "test_values",
        "comparison_range",
        "test_range",
        "mean_lower",
        "mean_upper",
        "test_moving_averages",
        "should_trigger",
        "num_moving_averages_compared",
        "InputSet",
        "client",
        "started_at",
        "finished_at",
        "num_ranges_compared",
        "range_alarm",
        "range_low",
        "range_high",
        "range_test_vals",
        "finished_at",
        "num_moving_averages_compared",
        "mean_alarm",
        "mean_low",
        "mean_high",
        "mean_window",
        "mean_test_vals",
        "rows_to_insert",
        "errors"
    ],
    "comments": [
        "We are using f-strings here because BQ does not allow table names to be parametrized",
        "and we need to be able to run the same script in the staging and prod db environments for reliable testing outcomes.",
        "We are using f-strings here because BQ does not allow table names to be parametrized",
        "and we need to be able to run the same script in the staging and prod db environments for reliable testing outcomes."
    ],
    "docstrings": [
        "\"\"\"\n    Calculate metrics for determining whether our search volume is changing in ways that might invalidate our current sanitization model.\n\n    Arguments:\n\n    - metadata_source: a string. The name of the table containing the metadata to be fetched.\n    - languages_source: a string. The name of the table containing language distributions for search term jobs.\n\n    Returns: A dataframe of the data validation metrics for the sanitization jobs.\n    \"\"\"",
        "\"\"\"\n    Append data validation metrics to the BigQuery table tracking these metrics from job metadata.\n\n    Arguments:\n    - dataframe: A dataframe of validation metrics to be added.\n    - destination_table_id: the fully qualified name of the table for the data to be exported into.\n\n    Returns: Nothing.\n    It does print a result value as a cursory logging mechanism. That result object can be parsed and logged to wherever we like.\n    \"\"\"",
        "\"\"\"\n    Pull all the sanitization job data validation metrics.\n\n    Arguments:\n\n    - metadata_source: a string. The name of the table containing the data validation metrics to be fetched.\n\n    Returns: A dataframe of the data validation metrics.\n    \"\"\"",
        "\"\"\"\n    Determines if all the values in a test window of days fall inside some percentile of the normal range for a set of comparison values in a comparison window of days.\n\n    Inputs:\n\n    - validation_data: the dataframe with the data in it to be checked.\n    ASSUMES the presence of a 'finished_at' column, whose date is used to calculate lookback and test windows.\n    - metric: the name of the column in the input dataframe on which to perform the check.\n    - full_lookback_window: an integer number of days that the comparison set should cover.\n    - test_window. an integer number of days that the test set should cover.\n    ASSUMES that the test window immediately succeeds the full_lookback_window.\n    - range_lower_bound: a float between 0 and 1 indicating the lower edge of the window of normal values from the comparison set\n    inside which at least one of the values in the test set should fall.\n    - range_upper_bound: a float between 0 and 1 indicating the upper edge of the window of normal values from the comparison set\n    inside which at least one of the values in the test set should fall.\n\n\n    Outputs:\n    - finished_at: the finished_at timestamp of the job run to which this check applies.\n    - num_values_compared: an integer representing the total number of range values included in this comparison.\n    - should_trigger: a bool indicating whether the values in the test window are all falling OUTSIDE the expected range.\n    - range_lower: a float. The lower bound of the expected range calculated from comparison values.\n    - range_upper: a float. The upper bound of the expected range calculated from comparison values.\n    - test_range: a list. The entirety of the test values.\n\n    \"\"\"",
        "\"\"\"\n    Determines if all the moving averages in a test window of days fall inside some percentile of the moving average for a set of comparison values in a comparison window of days.\n\n    Inputs:\n\n    - validation_data: the dataframe with the data in it to be checked.\n    ASSUMES the presence of a 'finished_at' column, whose date is used to calculate lookback and test windows.\n    - metric: the name of the column in the input dataframe on which to perform the check.\n    - full_lookback_window: an integer number of days that the comparison set should cover.\n    - test_window. an integer number of days that the test set should cover.\n    ASSUMES that the test window immediately succeeds the full_lookback_window.\n    - moving_average_window: an integer. Number of prior days over which to calculate an average for a given day.\n    - mean lower bound: a float between 0 and 1 indicating the lower edge of the window of normal values from the comparison set\n    inside which at least one of the values in the test set should fall.\n    - mean upper bound: a float between 0 and 1 indicating the upper edge of the window of normal values from the comparison set\n    inside which at least one of the values in the test set should fall.\n\n\n    Outputs:\n    - finished_at: the finished_at timestamp of the job run to which this check applies.\n    - num_moving_averages_compared: an integer representing the total number of moving average values included in this comparison.\n    - should_trigger: a bool indicating whether the values in the test window are all falling OUTSIDE the expected range.\n    - mean_lower: a float. The lower bound of the expected range of moving averages calculated from comparison values.\n    - mean_upper: a float. The upper bound of the expected range of moving averages calculated from comparison values.\n    - moving_average_windo: an integer. The moving average window passed into the function.\n    - test_moving_averages: a list. The entirety of the test values.\n\n    \"\"\""
    ],
    "functions": [
        "calculate_data_validation_metrics",
        "export_data_validation_metrics_to_bigquery",
        "retrieve_data_validation_metrics",
        "range_check",
        "mean_check",
        "record_validation_results"
    ],
    "classes": []
}