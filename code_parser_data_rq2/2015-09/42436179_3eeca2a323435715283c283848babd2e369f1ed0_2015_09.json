{
    "identifiers": [
        "chrome",
        "items",
        "prefs",
        "items",
        "refresh_options",
        "chrome",
        "refresh_options",
        "chrome",
        "tab",
        "prefs",
        "chrome",
        "tabs",
        "setInterval",
        "counter",
        "chrome",
        "tabs",
        "randomString",
        "timer",
        "activated",
        "chrome",
        "chrome",
        "prefs",
        "len",
        "len",
        "len",
        "chars",
        "_i",
        "_i",
        "len",
        "_i",
        "chars",
        "maxPos"
    ],
    "literals": [
        "'bullet'",
        "'弹幕测试'",
        "''",
        "'http://aidistan.github.io/firefox-weixin-danmu/helper.html'",
        "'https://wx.qq.com/'",
        "'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxy0z123456789'",
        "''"
    ],
    "variables": [
        "prefs",
        "activated",
        "counter",
        "timer",
        "chars",
        "maxPos"
    ],
    "comments": [
        "Get options",
        "Global Variables",
        "Toolbar Button",
        "// Attach weixin.js",
        "var pagemod = pageMod.PageMod({",
        "include: ['*.qq.com', '*.wechat.com'],",
        "attachTo: 'top',",
        "contentScriptFile: [",
        "self.data.url('vendor/jquery-2.1.3.min.js'),",
        "self.data.url('weixin.js')",
        "],",
        "onAttach: function(worker){",
        "showNotification({ title: '加载消息捕获模块', text: '至页面' + worker.url });",
        "",
        "worker.port.on('bullet', function(msg) {",
        "if (prefs.showAllMessages || msg.room == 'inside') {",
        "showNotification({ title: '捕获到消息', text: msg.content.text });",
        "if (dm_worker) {",
        "dm_worker.port.emit('bullet', msg);",
        "}",
        "}",
        "});",
        "",
        "var timer;",
        "worker.port.on('heartbeat', function() {",
        "if (activated) {",
        "window.clearTimeout(timer);",
        "}",
        "else {",
        "hookup();",
        "}",
        "timer = setTimeout(breakup, 5000);",
        "});",
        "",
        "function hookup() {",
        "showNotification({ title: '已登陆网页微信', text: '开始监听微信消息' });",
        "activated = true;",
        "button.icon = {",
        "'16': './icons/icon-16.png',",
        "'32': './icons/icon-32.png',",
        "'64': './icons/icon-64.png'",
        "};",
        "}",
        "",
        "function breakup() {",
        "showNotification({ title: '已退出网页微信', text: '不再监听微信消息'  });",
        "button.icon = {",
        "'16': './icons/icon-o-16.png',",
        "'32': './icons/icon-o-32.png',",
        "'64': './icons/icon-o-64.png'",
        "};",
        "activated = false;",
        "}",
        "",
        "// Store the worker",
        "wx_workers[worker.tab.id] = worker;",
        "}",
        "});",
        "",
        "// Attach danmu.js",
        "for (let tab of tabs) { bindDanmu(tab); }",
        "tabs.on('open', bindDanmu);",
        "tabs.on('activate', switchDanmu);",
        "",
        "// Utility functions",
        "function bindDanmu(tab) {",
        "attachDanmu(tab);",
        "tab.on('pageshow', attachDanmu);",
        "}",
        "",
        "function switchDanmu(tab) {",
        "dm_worker = dm_workers[tab.id];",
        "if (dm_worker) {",
        "pushDanmuSettings(dm_worker);",
        "}",
        "}",
        "",
        "function attachDanmu(tab) {",
        "// Do not attach to places where scripts are blocked internally",
        "if (/about:/.test(tab.url)) {",
        "return;",
        "}",
        "",
        "showNotification({ title: '加载弹幕发射模块', text: '至页面' + tab.url });",
        "var worker = tab.attach({",
        "contentScriptFile: [",
        "self.data.url('vendor/jquery-2.1.3.min.js'),",
        "self.data.url('danmu.js')",
        "]",
        "});",
        "pushDanmuSettings(worker);",
        "",
        "dm_workers[tab.id] = worker;",
        "if (tabs.activeTab.id == tab.id) {",
        "dm_worker = worker;",
        "}",
        "}",
        "",
        "function pushDanmuSettings(worker) {",
        "worker.port.emit('setup', prefs);",
        "}",
        "",
        "function showNotification(notify) {",
        "if (prefs.showNotifications) {",
        "toaster.notify({",
        "title: notify.title,",
        "text: notify.text,",
        "iconURL: self.data.url('icons/icon.png')",
        "});",
        "}",
        "}",
        "",
        "// Handle things down on unload",
        "exports.onUnload = function (reason) {",
        "var id;",
        "",
        "// Stop modifying pages",
        "pagemod.destroy();",
        "",
        "// Destroy wx_workers",
        "for (id in wx_workers) { wx_workers[id].destroy(); }",
        "",
        "// Stop listening to \"open\" and \"activate\" events from tabs",
        "// FIXME: Which method to call ?",
        "// tabs.destroy();",
        "",
        "// Stop listening to \"pageshow\" events from tab",
        "for (let tab of tabs) { tab.destroy(); }",
        "",
        "// Destroy dm_workers",
        "for (id in dm_workers) { dm_workers[id].destroy(); }",
        "};"
    ],
    "docstrings": [],
    "functions": [
        "refresh_options",
        "randomString"
    ],
    "classes": []
}