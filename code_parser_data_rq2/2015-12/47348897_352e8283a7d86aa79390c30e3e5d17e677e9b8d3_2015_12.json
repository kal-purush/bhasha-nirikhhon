{
    "identifiers": [
        "logDB",
        "Mongo",
        "today",
        "startDay",
        "startDay",
        "startDay",
        "numDays",
        "startDay",
        "startDay",
        "log",
        "today",
        "log",
        "startDay",
        "log",
        "getActiveClassCounts",
        "startDay",
        "log",
        "activeClassCounts",
        "day",
        "activeClassCounts",
        "today",
        "day",
        "insertEventCount",
        "day",
        "activeClassCounts",
        "day",
        "log",
        "scriptStartTime",
        "err",
        "log",
        "err",
        "printjson",
        "err",
        "startDay",
        "startDay",
        "db",
        "minGroupSize",
        "cursor",
        "cursor",
        "doc",
        "a",
        "userPlayedMap",
        "a",
        "a",
        "classes",
        "doc",
        "members",
        "cursor",
        "db",
        "cursor",
        "cursor",
        "doc",
        "bulkSubGroups",
        "purchaser",
        "bulkSubGroups",
        "purchaser",
        "bulkSubGroups",
        "purchaser",
        "doc",
        "purchaser",
        "bulkSubGroups",
        "bulkSubGroups",
        "purchaser",
        "minGroupSize",
        "member",
        "bulkSubGroups",
        "purchaser",
        "userPlayedMap",
        "member",
        "classes",
        "purchaser",
        "bulkSubGroups",
        "purchaser",
        "bulkSubGroups",
        "cursor",
        "db",
        "cursor",
        "cursor",
        "doc",
        "bulkSubGroups",
        "purchaser",
        "bulkSubGroups",
        "purchaser",
        "bulkSubGroups",
        "purchaser",
        "doc",
        "purchaser",
        "bulkSubGroups",
        "bulkSubGroups",
        "purchaser",
        "minGroupSize",
        "member",
        "bulkSubGroups",
        "purchaser",
        "userPlayedMap",
        "member",
        "classes",
        "purchaser",
        "bulkSubGroups",
        "purchaser",
        "bulkSubGroups",
        "cursor",
        "db",
        "minGroupSize",
        "cursor",
        "cursor",
        "doc",
        "i",
        "doc",
        "i",
        "userPlayedMap",
        "doc",
        "i",
        "members",
        "doc",
        "i",
        "classes",
        "owner",
        "members",
        "cursor",
        "db",
        "minGroupSize",
        "cursor",
        "cursor",
        "doc",
        "doc",
        "doc",
        "doc",
        "i",
        "doc",
        "i",
        "userPlayedMap",
        "doc",
        "i",
        "members",
        "doc",
        "i",
        "classroomCourseInstancesMap",
        "classroom",
        "classroomCourseInstancesMap",
        "classroom",
        "classroomCourseInstancesMap",
        "classroom",
        "doc",
        "owner",
        "members",
        "ISODate",
        "startDay",
        "startDate",
        "startDate",
        "daysInMonth",
        "ISODate",
        "startDay",
        "objectIdWithTimestamp",
        "startDate",
        "startObj",
        "userPlayedMap",
        "cursor",
        "logDB",
        "queryParams",
        "cursor",
        "cursor",
        "userPlayedMap",
        "doc",
        "doc",
        "endDate",
        "todayDate",
        "endDate",
        "classes",
        "i",
        "classes",
        "i",
        "j",
        "classes",
        "i",
        "j",
        "classes",
        "i",
        "j",
        "userPlayedMap",
        "member",
        "k",
        "userPlayedMap",
        "member",
        "k",
        "userPlayedMap",
        "member",
        "k",
        "startDate",
        "userPlayedMap",
        "member",
        "k",
        "endDate",
        "activeMemberCount",
        "activeMemberCount",
        "classes",
        "i",
        "classes",
        "i",
        "endDay",
        "startDate",
        "startDate",
        "endDate",
        "endDate",
        "cursor",
        "db",
        "cursor",
        "cursor",
        "courseNameMap",
        "doc",
        "doc",
        "classroom",
        "classroomCourseInstancesMap",
        "i",
        "classroomCourseInstancesMap",
        "classroom",
        "i",
        "classroomCourseInstancesMap",
        "classroom",
        "i",
        "owner",
        "owner",
        "courseInstance",
        "j",
        "courseInstance",
        "j",
        "courseNameMap",
        "courseInstance",
        "freeMembers",
        "courseInstance",
        "j",
        "paidMembers",
        "courseInstance",
        "j",
        "owner",
        "freeMembers",
        "owner",
        "paidMembers",
        "startDate",
        "ISODate",
        "startDay",
        "startDate",
        "startDate",
        "daysInMonth",
        "endDate",
        "ISODate",
        "startDay",
        "endDate",
        "todayDate",
        "endDate",
        "j",
        "paidClass",
        "j",
        "paidClass",
        "j",
        "userPlayedMap",
        "member",
        "k",
        "userPlayedMap",
        "member",
        "k",
        "userPlayedMap",
        "member",
        "k",
        "startDate",
        "userPlayedMap",
        "member",
        "k",
        "endDate",
        "paidActiveMemberCount",
        "paidClass",
        "minGroupSize",
        "paidActiveMemberCount",
        "paidClass",
        "paidClass",
        "endDay",
        "j",
        "freeClass",
        "j",
        "freeClass",
        "j",
        "userPlayedMap",
        "member",
        "k",
        "userPlayedMap",
        "member",
        "k",
        "userPlayedMap",
        "member",
        "k",
        "startDate",
        "userPlayedMap",
        "member",
        "k",
        "endDate",
        "freeActiveMemberCount",
        "freeClass",
        "minGroupSize",
        "freeActiveMemberCount",
        "freeClass",
        "freeClass",
        "endDay",
        "startDate",
        "startDate",
        "endDate",
        "endDate",
        "classes",
        "freeClass",
        "classes",
        "paidClass",
        "classes",
        "activeClassCounts",
        "activeClassCounts",
        "i",
        "classes",
        "i",
        "endDay",
        "classes",
        "i",
        "activeClassCounts",
        "endDay",
        "activeClassCounts",
        "endDay",
        "activeClassCounts",
        "endDay",
        "activeClassCounts",
        "text",
        "text",
        "timestamp",
        "timestamp",
        "timestamp",
        "timestamp",
        "timestamp",
        "ObjectId",
        "hexSeconds",
        "constructedObjectId",
        "analyticsStringCache",
        "analyticsStringCache",
        "db",
        "doc",
        "analyticsStringCache",
        "doc",
        "analyticsStringCache",
        "doc",
        "db",
        "cursor",
        "cursor",
        "doc",
        "seq",
        "db",
        "doc",
        "results",
        "results",
        "tojson",
        "results",
        "doc",
        "db",
        "doc",
        "analyticsStringCache",
        "doc",
        "analyticsStringCache",
        "day",
        "count",
        "day",
        "day",
        "getAnalyticsString",
        "getAnalyticsString",
        "objectIdWithTimestamp",
        "startDay",
        "day",
        "eventID",
        "filterID",
        "db",
        "queryParams",
        "doc",
        "doc",
        "count",
        "doc",
        "doc",
        "count",
        "db",
        "queryParams",
        "count",
        "results",
        "results",
        "log",
        "printjson",
        "results",
        "day",
        "eventID",
        "filterID",
        "count",
        "db",
        "insertDoc",
        "results",
        "log",
        "printjson",
        "results",
        "printjson",
        "insertDoc"
    ],
    "literals": [
        "\"localhost\"",
        "\"analytics\"",
        "\"Today is \"",
        "\"Start day is \"",
        "\"Getting active class counts...\"",
        "\"Inserting active class counts...\"",
        "\"Script runtime: \"",
        "\"ERROR: \"",
        "'Active classes private clan'",
        "'Active classes managed subscription'",
        "'Active classes bulk subscription'",
        "'Active classes prepaid'",
        "'Active classes course free'",
        "'Active classes course paid'",
        "'private'",
        "'this.members.length >= '",
        "'Active classes private clan'",
        "'stripe'",
        "'!this.purchaser.equals(this.recipient)'",
        "'Active classes managed subscription'",
        "'external'",
        "'!this.purchaser.equals(this.recipient)'",
        "'Active classes bulk subscription'",
        "'terminal_subscription'",
        "'this.redeemers && this.redeemers.length >= '",
        "'Active classes prepaid'",
        "'this.members && this.members.length >= '",
        "\"T00:00:00.000Z\"",
        "\"T00:00:00.000Z\"",
        "'Started Level'",
        "'log'",
        "'Introduction to Computer Science'",
        "\"T00:00:00.000Z\"",
        "\"T00:00:00.000Z\"",
        "'Active classes course free'",
        "'Active classes course paid'",
        "'-'",
        "''",
        "'-'",
        "''",
        "''",
        "\" \"",
        "'string'",
        "\"0000000000000000\"",
        "'analytics.strings'",
        "'analytics.strings'",
        "'analytics.strings'",
        "\"ERROR: Unexpected error inserting data: \"",
        "'analytics.strings'",
        "\"ERROR: Did not find analytics.strings insert for: \"",
        "''",
        "'all'",
        "\"T00:00:00.000Z\"",
        "'analytics.perdays'",
        "'analytics.perdays'",
        "\"ERROR: update event count failed\"",
        "'analytics.perdays'",
        "\"ERROR: insert event failed\""
    ],
    "variables": [
        "scriptStartTime",
        "analyticsStringCache",
        "numDays",
        "daysInMonth",
        "startDay",
        "activeClassCounts",
        "minGroupSize",
        "classes",
        "userPlayedMap",
        "cursor",
        "doc",
        "members",
        "bulkSubGroups",
        "doc",
        "purchaser",
        "doc",
        "purchaser",
        "doc",
        "owner",
        "members",
        "i",
        "classroomCourseInstancesMap",
        "doc",
        "owner",
        "classroom",
        "members",
        "i",
        "startDate",
        "endDate",
        "todayDate",
        "startObj",
        "queryParams",
        "doc",
        "endDay",
        "i",
        "activeMemberCount",
        "j",
        "member",
        "k",
        "courseNameMap",
        "doc",
        "freeMembers",
        "paidMembers",
        "owner",
        "i",
        "courseInstance",
        "j",
        "freeClass",
        "paidClass",
        "endDay",
        "paidActiveMemberCount",
        "j",
        "member",
        "k",
        "freeActiveMemberCount",
        "j",
        "member",
        "k",
        "activeClassCounts",
        "i",
        "hexSeconds",
        "constructedObjectId",
        "doc",
        "cursor",
        "seq",
        "results",
        "eventID",
        "filterID",
        "startObj",
        "queryParams",
        "doc",
        "results",
        "insertDoc",
        "results"
    ],
    "comments": [
        "Insert per-day active class counts into analytics.perdays collection",
        "Usage:",
        "mongo <address>:<port>/<database> <script file> -u <username> -p <password>",
        "printjson(activeClassCounts);",
        "Never save data for today because it's incomplete",
        "Tally active classes per day",
        "TODO: does not handle class membership changes",
        "Private clans",
        "TODO: does not handle clan membership changes over time",
        "Managed subscriptions",
        "TODO: does not handle former recipients playing after sponsorship ends",
        "Bulk subscriptions",
        "Prepaids terminal_subscription",
        "Classrooms",
        "printjson(classroomCourseInstancesMap);",
        "Find all the started level events for our class members, for startDay - daysInMonth",
        "printjson(userPlayedMap);",
        "print(startDate, endDate, todayDate);",
        "Now we have a set of classes, and when users played",
        "For a given day, walk classes and find out how many members were active during the previous daysInMonth",
        "For each class",
        "For each member of current class",
        "Was member active during current timeframe?",
        "Classes active for a given day if has minGroupSize members, and at least 1/2 played in last daysInMonth days",
        "Classrooms are processed differently because they could be free or paid active classes",
        "For each classroom, check free and paid members separately",
        "print('Processing classroom', classroom, freeClass.members.length, paidClass.members.length);",
        "For each paid member of current class",
        "Was member active during current timeframe?",
        "Classes active for a given day if has minGroupSize members, and at least 1/2 played in last daysInMonth days",
        "print('paid classroom', classroom, endDay);",
        "For each free member of current class",
        "Was member active during current timeframe?",
        "print('free classroom', classroom, endDay);",
        "printjson(freeClass);",
        "printjson(paidClass);",
        "printjson(classes['Active classes course paid']);",
        "https://gist.github.com/mathewbyrne/1280286",
        "Replace spaces with -",
        "Remove all non-word chars",
        "Replace multiple - with single -",
        "Trim - from start of text",
        "Trim - from end of text",
        "Convert string date to Date object (otherwise assume timestamp is a date)",
        "Convert date object to hex seconds since Unix epoch",
        "Create an ObjectId with that hex timestamp",
        "Find existing string",
        "Insert string",
        "http://docs.mongodb.org/manual/tutorial/create-an-auto-incrementing-field/#auto-increment-optimistic-loop",
        "dup key",
        "Find new string entry",
        "analytics.perdays schema in server/analytics/AnalyticsPeryDay.coffee",
        "Update existing count, assume new one is more accurate",
        "log(\"Updating count in db for \" + day + \" \" + event + \" \" + doc.c + \" => \" + count);",
        "else {",
        "log(\"Added \" + day + \" \" + event + \" \" + count);",
        "}"
    ],
    "docstrings": [
        "*** Helper functions ***"
    ],
    "functions": [
        "getActiveClassCounts",
        "slugify",
        "log",
        "objectIdWithTimestamp",
        "getAnalyticsString",
        "insertEventCount"
    ],
    "classes": []
}