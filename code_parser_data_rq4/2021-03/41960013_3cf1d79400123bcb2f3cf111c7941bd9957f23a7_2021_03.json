{
    "identifiers": [
        "time",
        "sqlalchemy",
        "psycopg2",
        "psycopg2",
        "errors",
        "OperationalError",
        "psycopg2",
        "extras",
        "execute_values",
        "ujson",
        "flask",
        "current_app",
        "listenbrainz",
        "db",
        "data",
        "db",
        "engine",
        "raw_connection",
        "conn",
        "cursor",
        "curs",
        "curs",
        "execute",
        "curs",
        "execute",
        "user",
        "similar",
        "data",
        "items",
        "values",
        "append",
        "user",
        "ujson",
        "dumps",
        "similar",
        "len",
        "values",
        "ROWS_PER_BATCH",
        "execute_values",
        "curs",
        "query",
        "values",
        "template",
        "execute_values",
        "curs",
        "query",
        "values",
        "template",
        "conn",
        "commit",
        "psycopg2",
        "errors",
        "OperationalError",
        "err",
        "conn",
        "rollback",
        "current_app",
        "logger",
        "error",
        "err",
        "conn",
        "cursor",
        "curs",
        "curs",
        "execute",
        "curs",
        "execute",
        "curs",
        "execute",
        "curs",
        "execute",
        "curs",
        "execute",
        "time",
        "time",
        "curs",
        "execute",
        "time",
        "time",
        "conn",
        "commit",
        "psycopg2",
        "errors",
        "OperationalError",
        "err",
        "conn",
        "rollback",
        "current_app",
        "logger",
        "error",
        "err",
        "conn",
        "cursor",
        "curs",
        "curs",
        "execute",
        "curs",
        "execute",
        "conn",
        "commit",
        "psycopg2",
        "errors",
        "OperationalError",
        "err",
        "conn",
        "rollback",
        "current_app",
        "logger",
        "error",
        "err",
        "conn",
        "cursor",
        "curs",
        "curs",
        "execute",
        "conn",
        "commit",
        "psycopg2",
        "errors",
        "OperationalError",
        "err",
        "conn",
        "rollback",
        "current_app",
        "logger",
        "error",
        "err"
    ],
    "literals": [
        "\"INSERT INTO recommendation.similar_user_import VALUES %s\"",
        "\"Error: Cannot import user similarites: %s\"",
        "\"Error: Cannot correlate user similarity user name: %s\"",
        "\"Error: Failed to rotate similar_users table into place: %s\"",
        "\"Error: Failed to clean up old similar user table: %s\""
    ],
    "variables": [
        "ROWS_PER_BATCH",
        "conn",
        "query",
        "values",
        "values"
    ],
    "comments": [
        "Start by importing the data into an import table",
        "Next lookup user names and insert them into the new similar_users table",
        "Give each constraint a unique name so that we don't have to deal with PITA constraint renaming",
        "Finally rotate the table into place",
        "Last, delete the old table"
    ],
    "docstrings": [
        "\"\"\" Import the user similarities into the DB by inserting the data into a new table\n        and then rotating the table into place atomically.\n    \"\"\"",
        "\"\"\"DROP TABLE IF EXISTS recommendation.similar_user_import\"\"\"",
        "\"\"\"CREATE TABLE recommendation.similar_user_import  (\n                                user_name     VARCHAR NOT NULL,\n                                similar_users JSONB)\"\"\"",
        "\"\"\"DROP TABLE IF EXISTS recommendation.tmp_similar_user\"\"\"",
        "\"\"\"CREATE TABLE recommendation.tmp_similar_user\n                                         (LIKE recommendation.similar_user\n                                          EXCLUDING INDEXES\n                                          EXCLUDING CONSTRAINTS\n                                          INCLUDING DEFAULTS)\"\"\"",
        "\"\"\"INSERT INTO recommendation.tmp_similar_user\n                                        SELECT id AS user_id, similar_users\n                                          FROM recommendation.similar_user_import\n                                          JOIN \"user\" \n                                            ON user_name = musicbrainz_id\"\"\"",
        "\"\"\"DROP TABLE recommendation.similar_user_import\"\"\"",
        "\"\"\"CREATE UNIQUE INDEX user_id_ndx_similar_user_%s\n                                             ON recommendation.tmp_similar_user (user_id)\"\"\"",
        "\"\"\"ALTER TABLE recommendation.tmp_similar_user\n                         ADD CONSTRAINT similar_user_user_id_foreign_key_%s\n                            FOREIGN KEY (user_id)\n                             REFERENCES \"user\" (id)\n                              ON DELETE CASCADE\"\"\"",
        "\"\"\"ALTER TABLE recommendation.similar_user\n                              RENAME TO delete_similar_user\"\"\"",
        "\"\"\"ALTER TABLE recommendation.tmp_similar_user\n                              RENAME TO similar_user\"\"\"",
        "\"\"\"DROP TABLE recommendation.delete_similar_user CASCADE\"\"\""
    ],
    "functions": [
        "import_user_similarities"
    ],
    "classes": []
}